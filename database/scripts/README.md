# 数据库迁移脚本管理

## 命名规范

所有迁移脚本必须遵循以下命名规范：

```
{版本号}_{描述}.sql
```

- **版本号**: 3位数字，从001开始递增（如：001, 002, 003...）
- **描述**: 简短的英文描述，使用下划线分隔单词
- **扩展名**: 必须是 `.sql`

### 示例

- `001_create_migration_table.sql` - 创建迁移历史表
- `002_create_user_role_organ_tables.sql` - 创建用户角色组织表
- `003_add_user_email_column.sql` - 添加用户邮箱字段
- `004_create_project_tables.sql` - 创建项目相关表

## 脚本结构

每个迁移脚本应包含以下结构：

```sql
-- =============================================
-- 脚本标题
-- Version: 版本号
-- Create Time: 创建时间
-- Description: 详细描述
-- =============================================

-- Use database
USE `pms_db`;

-- 实际的SQL语句
-- ...

SELECT '脚本执行成功消息' as message;
```

## 迁移执行流程

1. **自动检测**: 应用启动时自动扫描 `database/scripts/` 目录
2. **版本比较**: 与 `migration_history` 表中的记录比较，找出未执行的脚本
3. **按序执行**: 按版本号顺序执行未执行的脚本
4. **记录历史**: 执行结果记录到 `migration_history` 表
5. **错误处理**: 如果某个脚本执行失败，停止后续脚本执行

## 注意事项

1. **不可修改**: 一旦脚本被执行，不应再修改其内容
2. **向前兼容**: 新的迁移脚本应保持向前兼容性
3. **事务安全**: 每个脚本在事务中执行，失败时自动回滚
4. **测试验证**: 在生产环境执行前，应在开发环境充分测试
5. **备份数据**: 执行重要迁移前建议备份数据库

## 迁移历史表结构

`migration_history` 表记录所有已执行的迁移：

- `version`: 迁移版本号
- `script_name`: 脚本文件名
- `description`: 迁移描述
- `checksum`: 脚本内容校验和
- `executed_at`: 执行时间
- `execution_time_ms`: 执行耗时（毫秒）
- `success`: 执行是否成功
- `error_message`: 错误信息（如果失败）

## 手动执行迁移

如果需要手动执行特定迁移脚本：

```bash
# 连接到数据库
mysql -u root -p pms_db

# 执行脚本
source /path/to/script.sql
```

## 故障排除

1. **脚本执行失败**: 检查 `migration_history` 表中的 `error_message` 字段
2. **版本冲突**: 确保版本号唯一且按顺序递增
3. **权限问题**: 确保数据库用户有足够的权限执行DDL和DML操作
4. **语法错误**: 在执行前验证SQL语法的正确性